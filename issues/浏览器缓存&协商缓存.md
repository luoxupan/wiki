### Nginx配置示例
```
location / {
  root   /home/xiaoju/dws/log;
  #add_header Cache-Control no-store;
  add_header Cache-Control no-cache;
  #add_header Cache-Control max-age=0;
  #add_header Cache-Control max-age=180;
  index  index.html index.htm report.html;
}
```

### 从http协议版本解读缓存

- `Expires` 是`HTTP/1.0`中的，`Cache-Control` 是`HTTP/1.1`中的
- `Expires` 是为了兼容，在不支持` HTTP/1.1` 的情况下才会发生作用
- 两者同时存在的话` Cache-Control` 优先级高于` Expires`

### 强缓存：Cache-Control: max-age=秒；
> 强缓存时间过期时，服务器会启用协商缓存

设置缓存存储的最大周期，超过这个时间缓存被认为过期(单位秒)。与Expires相反，时间是相对于请求的时间。（`Expires` 响应头包含日期/时间----是一个时间点， 即在此时候之后，响应过期）


### 协商缓存：Cache-Control: no-cache；
> The response may be stored by any cache, even if the response is normally non-cacheable. However, the stored response MUST always go through validation with the origin server first before using it, therefore, you cannot use `no-cache` in-conjunction with `immutable`. **If you mean to not store the response in any cache, use `no-store` instead**. This directive is not effective in preventing caches from storing your response.

- [浏览器第一次请求时，服务器返回头] 
- **ETag**是资源的特定版本的标识符
- **Last-Modified**是资源做出修改的日期及时间
```
Response Headers:
  Accept-Ranges: bytes
  Cache-Control: no-cache
  Connection: keep-alive
  Content-Length: 53
  Content-Type: text/html; charset=utf-8
  Date: Sun, 10 Jan 2021 02:41:08 GMT
  ETag: "5ff828df-35"
  Last-Modified: Fri, 08 Jan 2021 09:41:51 GMT
  Server: nginx/1.6.2
```
- [浏览器再次请求时，浏览器请求头] 
- 会带上**If-None-Match**（值对应上次返回头ETag）和**If-Modified-Since**（值对应上次返回头Last-Modified）
```
Request Headers:
  Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
  Accept-Encoding: gzip, deflate
  Accept-Language: zh-CN,zh;q=0.9,en;q=0.8
  Cache-Control: max-age=0
  Connection: keep-alive
  Cookie: dp=US; country=BR; utc=; _OMGID=877540dc-3a65-40c0-8c18-6d1ad6326cb1; __hash__cache=65f913ae-805e-4f2a-8e7f-7c3073d20235; lang=en-US
  Host: 10.190.11.26:8808
  If-Modified-Since: Fri, 08 Jan 2021 09:41:51 GMT
  If-None-Match: "5ff828df-35"
  Upgrade-Insecure-Requests: 1
  User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36
```

### 禁止缓存：Cache-Control: no-store；
> The response may **not** be stored in any cache. Note that this will not prevent a valid _pre-existing_ cached response being returned. Clients can set `max-age=0` to also clear existing cache responses, as this forces the cache to revalidate with the server (no other directives have an effect when used with `no-store`).

### 检查缓存
> 检查缓存一定是在发起真正的请求之前进行的，只有这样缓存的机制才会生效。如果发现有对应的缓存资源，则去检查缓存的有效期。

- 在有效期内的缓存资源直接使用，称之为强缓存。文件命中**强缓存**则请求直接返回**200**，`size`是**memory cache**或者**disk cache**。memory cache是指从资源从内存中被取出，disk cache是指从磁盘中被取出；从内存中读取比从磁盘中快很多，但资源能不能分配到内存要取决于当下的系统状态。通常来说，刷新页面会使用内存缓存，关闭后重新打开会使用磁盘缓存。
- 超过有效期的，则携带缓存的资源标识向服务端发起请求，校验是否能继续使用，如果服务端告诉我们，可以继续使用本地存储，则返回**304**，并且不携带数据；如果服务端告诉我们需要用更新的资源，则返回200，并且携带更新后的资源和资源标识缓存到本地，方便下一次使用。

#### 参考借鉴：
[浏览器的工作原理：新式网络浏览器幕后揭秘(MDN推荐)](https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/)

[http-caching](https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching)

[Cache-Control](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control)

[RFC7232翻译](https://duoani.github.io/HTTP-RFCs.zh-cn/RFC7232.html)

[Caching Tutorial](https://www.mnot.net/cache_docs/)

---


![image](https://user-images.githubusercontent.com/7278711/104113528-83878180-5335-11eb-9d08-60fa9413c73b.png)


---

![image](https://user-images.githubusercontent.com/7278711/104113532-8edaad00-5335-11eb-8539-2e953c415921.png)





